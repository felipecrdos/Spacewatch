[gd_scene load_steps=5 format=2]

[ext_resource path="res://scenes/enemy/EnemyPath.tscn" type="PackedScene" id=1]
[ext_resource path="res://scripts/enemy/SpawnDEnemy.gd" type="Script" id=2]

[sub_resource type="Curve2D" id=1]
_data = {
"points": PoolVector2Array( 0, 0, 0, 0, 191.428, -289.568, 106.598, -23.4969, -106.598, 23.4969, 207.844, 83.1846, 72.2267, -35.7165, -72.2267, 35.7165, 72.5823, 46.5699, -130.939, -41.851, 130.939, 41.851, 127.348, 215.172, 69.0519, 14.2866, -69.0519, -14.2866, 98.7745, 294.007, 0, 0, 0, 0, -79.5063, 367.168 )
}

[sub_resource type="GDScript" id=2]
script/source = "extends Path2D
class_name EnemyPath

export (float) var follow_speed setget set_follow_speed
export (int) var number_follows setget set_number_follows
export (float) var enemy_offset setget set_enemy_offset
export (PackedScene) var enemy setget set_packedscene_enemy
export (float) var start_delay setget set_start_delay
export (bool) var follow_loop setget set_follow_loop
export (bool) var follow_rotate setget set_follow_rotate

var follows : Array
var ready = false

func _ready():
	create_follow()
	set_array_follows()
	set_follows_loop()
	set_follows_rotate()
	create_enemies()
	set_offset_between_enemies()
	
	$Delay.set_wait_time(start_delay)
	$Delay.start()

func _physics_process(delta):
	if ready:
		for follow in follows:
			follow.offset += follow_speed * delta
	
func create_follow():
	for i in range(number_follows):
		add_child(PathFollow2D.new())
		
func restart_follows():
	reset_follow_offset()
	set_offset_between_enemies()

func set_start_delay(value:float):
	start_delay = value
	
func recreate_enemies():
	for follow in follows:
		if !follow.get_children().size():
			follow.add_child(enemy.instance())

func followers_finished():
	var finished = true
	for follow in follows:
		if follow.unit_offset != 1:
			finished = false
	return finished
		
func set_offset_between_enemies():
	for i in follows.size():
		follows[i].offset += enemy_offset * i
	
func set_array_follows():
	for child in get_children():
		if child is PathFollow2D:
			follows.append(child)

func reset_follow_offset():
	for follow in follows:
		follow.set_offset(0)

func set_follows_loop():
	for follow in follows:
		follow.set_loop(false)

func set_follow_rotate(value:bool):
	follow_rotate = value

func set_follows_rotate():
	for follow in follows:
		follow.set_rotate(follow_rotate)
	
func create_enemies():
	for follow in follows:
		follow.add_child(enemy.instance())

func set_follows_offset():
	for follow in follows:
		follow.set_offset(enemy_offset)
	
#===
func set_follow_loop(value:bool):
	follow_loop = value

func get_follow_loop():
	return follow_loop
	
func set_follow_speed(value:float):
	follow_speed = value
	
func set_number_follows(value:int):
	number_follows = value
	
func set_enemy_offset(value:float):
	enemy_offset = value

func set_packedscene_enemy(value:PackedScene):
	enemy = value

func set_ready(value:bool):
	ready = value

func on_finished_timeout():
	if followers_finished():
		set_ready(false)
		$Finished.stop()
		
		if get_follow_loop():
			restart_follows()
			recreate_enemies()
			$Delay.start()
			$Finished.start()

func on_delay_timeout():
	if !ready:
		set_ready(true)
"

[node name="SpawnDEnemy" type="Position2D"]
script = ExtResource( 2 )
__meta__ = {
"_edit_group_": true
}

[node name="PathRight" parent="." instance=ExtResource( 1 )]
curve = SubResource( 1 )
script = SubResource( 2 )
start_delay = 4.0

[node name="PathLeft" parent="." instance=ExtResource( 1 )]
position = Vector2( 236, 0 )
scale = Vector2( -1, 1 )
curve = SubResource( 1 )
script = SubResource( 2 )
start_delay = 4.0
